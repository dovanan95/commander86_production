<!DOCTYPE html>
<html lang="en">
<head>
  <title>Group Option</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./bootstrap-5.1.3-dist/css/bootstrap.min.css">
  <script src="./bootstrap-5.1.3-dist/js/jquery.slim.min.js"></script>
  <script src="./bootstrap-5.1.3-dist/js/popper.min.js"></script>
  <script src="./bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <p class="h1">NEW CHAT GROUP</p>
    <div class="modal-body row">
        <div class="col-md-6">
          <!-- Your first column here -->
          <label>SEARCH MEMBER</label>
          <div class="input-group">
            <input type="search" id="searchBox" class="form-control rounded" placeholder="Search" aria-label="Search" aria-describedby="search-addon" />
            <button type="button" onclick="searchUsers()" class="btn btn-outline-primary">search</button>
          </div>
          <table class="table" id="queryTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Department</th>
                <th>Mobile</th>
                <th>Select</th>
              </tr>
            </thead>
            <tbody>
              
            </tbody>
          </table>
        </div>
        <div class="col-md-6">
          <!-- Your second column here -->
          <div class="form-group">
            <label for="groupName">GROUP NAME</label>
            <input type="text" class="form-control" id="groupName" placeholder="Group Name">
          </div>
          <table class="table" id="memberListTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Department</th>
                <th>Mobile</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody>
             
            </tbody>
          </table>
          <button type="submit" onclick="generateGroup()" class="btn btn-primary">Submit</button>
        </div>
      </div>

</body>
</html>
<script>
    var myID_json = sessionStorage.getItem('login_data');
    if(myID_json==null){
        if(window.confirm('ban khong co quyen truy cap!!!')){
            window.location.href='/';
        }
        else
        {
            window.location.href='/';
        }
    }
    else
    {
        var accessToken = JSON.parse(myID_json).accessToken;
        var refreshToken = JSON.parse(myID_json).refreshToken;
    }
    
    
    window.onload = async function(){
        const options = {
            method: 'GET',
            headers: {
                'authorization': 'token '+ accessToken
            }
        };
        var res= await fetch('/authenOnLoad', options);
        var res_json = await res.json();
        console.log(res_json.id);
        if(!res || res.status!=200)
        {
            if(window.confirm('ban khong co quyen truy cap!!!')){
                window.location.href='/';
            }
            else
            {
                window.location.href='/';
            }
        }
        
    }
    $(document).on('click', '.delete', function(){
        $(this).parents("tr").remove();
    })
    var selectBtn = document.getElementsByClassName('select');
    var queryTable = document.getElementById('queryTable').getElementsByTagName('tbody')[0];
    var memListTable = document.getElementById("memberListTable").getElementsByTagName('tbody')[0];
    for(var i=0; i<selectBtn.length;i++)
    {
        selectBtn[i].addEventListener('click', function(event){
            var thisTarget = event.currentTarget;
            var row = thisTarget.parentNode.parentNode;
            var lastBTN = row.cells[row.cells.length-1]; 
            lastBTN.innerHTML = `<button type="button" class="btn btn-outline-danger delete">Delete</button>`;
            memListTable.appendChild(row)
        })
    }

    function addNewMember(event){
        //var thisTarget = event.currentTarget;
        var row = event.parentNode.parentNode;
        var lastBTN = row.cells[row.cells.length-1]; 
        lastBTN.innerHTML = `<button type="button" class="btn btn-outline-danger delete">Delete</button>`;
        memListTable.appendChild(row)
    }

    async function searchUsers(){
        var searchBox = document.getElementById('searchBox');
        var userID = searchBox.value;
        const options = {
                  method: 'GET',
                  headers: {
                      'authorization': 'token '+ accessToken,
                  }
              }
        var res = await fetch('/searchUserByID?id='+userID, options);
        var res_json = await res.json();
        console.log(res_json);
        for(let i=0; i<res_json.data.length; i++)
        {
          var newRow = document.createElement('tr');
          var id = res_json.data[i]['id'];
          var name = res_json.data[i]['TenDayDu'];
          var dept = res_json.data[i]['TenDonVi'];
          var mobile = res_json.data[i]['Mobile'];
          var selectBtn =`<td><button type="button" onclick="addNewMember(this)" 
            class="btn btn-outline-primary select">Select</button></td> `;
          newRow.innerHTML= 
          `
            <td style="display:none;">${id}</td>
            <td>${name}</td>
            <td>${dept}</td>
            <td>${mobile}</td>
            ${selectBtn}
          `;
          console.log(queryTable.rows.length);
          var flag_q=0;
          var flag_m =0
          if(queryTable.rows.length>0){
            for(let j=0;j<queryTable.rows.length;j++){
              if(id==queryTable.rows[j].cells[0].innerHTML){
                flag_q=1;
              }
            }
          }

          if(memListTable.rows.length>0){
            for(let k=0; k<memListTable.rows.length;k++){
              if(id== memListTable.rows[k].cells[0].innerHTML){
                flag_m=1
              }
            }
          }
            
          if(flag_m==0 && flag_q==0){
              queryTable.appendChild(newRow);
          }
          
          if(queryTable.rows.length==0 && memListTable.rows.length==0)
          {
            queryTable.appendChild(newRow);
          }

        }
    }
    async function generateGroup(){
      var groupName= document.getElementById('groupName');
      if(memListTable.rows.length>0 && groupName.value != ''){
        var listUser = [];
        for(let i=0;i<memListTable.rows.length;i++){
          let id = memListTable.rows[i].cells[0].innerHTML;
          listUser.push(id);
        }
        console.log(groupName.value, listUser);
      }
    }

</script>
